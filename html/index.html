<html><head><title>sota</title>
</head>
<style type="text/css">
* {
    font-size: 1.2em;
}
html, body {
    margin: 0; padding: 0px; width: 100%; height: 100%; overflow: hidden;
}
#command {
    width: 100%; position: absolute; bottom: 0px; left: 0px;
}
</style>
<body>
    <canvas id="screen"></canvas>
    <input id="command" type="text" />


<script type="text/javascript">
const guid = () => {
  const s4 = () => Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1)
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4()
}
const id = localStorage && localStorage.getItem('sota_id') 
    ? localStorage.getItem('sota_id')
    : guid()
const name = localStorage && localStorage.getItem('sota_name')
    ? localStorage.getItem('sota_name')
    : (() => {
        while (true) {
            const name = prompt('What is your name?')
            if (name && name.trim()) {
                return name
            }
        }
    })()

localStorage.setItem('sota_id', id)
localStorage.setItem('sota_name', name)

const elements = []
const texts = []
const postQ = []

const act = msg => fetch('/q/', {
        method: 'POST',
        body: JSON.stringify(Object.assign({uid: id}, msg)),
        headers: {'Content-Type': 'application/json'}
    }).then(r => r.json())

const $window = window
const $command = document.getElementById('command')
const $screen = document.getElementById('screen')
$command.focus()
$command.addEventListener('keypress', e => {
    const text = ($command.value || '')
    if ('Enter' === e.key && text.trim()) {
        act({
            action: 'chat',
            value: text.trim()
        })
        $command.value = ''
        $command.focus()
    }
})

const fitSize = () => { 
    $screen.width = $window.innerWidth
    $screen.height = $window.innerHeight
}
fitSize()
$window.addEventListener('resize', fitSize);

const $ctx = $screen.getContext('2d')
const draw = {
    rect: (x, y, w, h, color) => {
        $ctx.fillStyle = color
        $ctx.fillRect(x, y, w, h, color)
    },
    text: (text, x, y, size, color) => {
        $ctx.font = size + 'px Serif'
        $ctx.fillStyle = color
        $ctx.fillText(text, x, y + size)        
    }
}

const poll = () => {
    act({
        action: 'poll'
    }).then(resp => {
        for (const msg of resp.messages) {
            console.log(msg)
        }
        poll()
    })
}
(() => {
    act({})
        .then(_ => act({action: 'name', value: name}))
        .then(_ => poll())
})()

const tick = (delta) => {
    draw.rect(0, 0, $screen.width, $screen.height, '#888888')
    for (const element of elements) {
    }

    let textY = 0
    for (const text of texts) {
        draw.text(text.value, 0, textY, 24, '#ffffff')
        text.alive += delta
        textY += 24
    }
    while (texts.length > 0) {
        if (texts[0].alive > 10 * 1000) {
            texts.shift()
        } else break;
    }
}

const loop = () => {
    let before = 0
    const iterator = (now) => {
        const delta = now - (before || now)
        tick(delta)
        before = now
        $window.requestAnimationFrame(iterator)
        /*
        $window.setTimeout(() => {
            iterator(new Date().getTime())
        }, 1000)
        */
    }
    iterator(0)
}
loop()
</script>
</body>
</html>
